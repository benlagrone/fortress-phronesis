networks:
  pericope_net:
    external: true
    name: pericope_net

volumes:
  corpus_indexes:
  mysql_data:

services:
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpass}
      - MYSQL_DATABASE=${MYSQL_DB:-augustine_chat}
      - MYSQL_USER=${MYSQL_USER:-augustine}
      - MYSQL_PASSWORD=${MYSQL_PASS:-password}
    ports:
      # If host 3306 is busy, override MYSQL_HOST_PORT (default 3307) in .env
      - "${MYSQL_HOST_PORT:-3307}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - pericope_net

  augustine-corpus-live:
    # Build directly from the corpus repo on disk; comment these lines and set image: if you push a registry image instead.
    build:
      context: /root/workspace/AugustineCorpus
      dockerfile: Dockerfile
    env_file:
      - /root/workspace/AugustineCorpus/.env
    environment:
      - CORPUS_VERSION=${CORPUS_VERSION:-live}
      - INDEX_DIR=/app/indexes
      - CORPUS_DATA_DIR=/app/texts
      - RUN_INDEXING_ON_START=${RUN_INDEXING_ON_START:-0}
      - USE_MOCK_LLM=${USE_MOCK_LLM:-false}
      - AUTHOR_INDEX_MAP=${AUTHOR_INDEX_MAP:-augustine=/app/indexes/augustine,freud=/app/indexes/freud,plato=/app/indexes/plato}
      - INDEX_CACHE_SIZE=${INDEX_CACHE_SIZE:-3}
    expose:
      - "8001"                         # internal only; no host mapping
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8001/healthz', timeout=5).read()\""]
      interval: 15s
      timeout: 5s
      retries: 5
    volumes:
      # Text sources (read-only)
      - /root/workspace/AugustineCorpus/texts/augustine_texts:/app/texts/augustine_texts:ro
      - /root/workspace/AugustineCorpus/texts/freud_texts:/app/texts/freud_texts:ro
      - /root/workspace/AugustineCorpus/texts/plato_texts:/app/texts/plato_texts:ro
      # Persisted indexes
      - corpus_indexes:/app/indexes
    networks:
      - pericope_net
    restart: unless-stopped

  pericopeai-indexer:
    build:
      context: /root/workspace/AugustineCorpus
      dockerfile: Dockerfile
    env_file:
      - /root/workspace/AugustineCorpus/.env
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-dev}
      - ENV=${ENV:-dev}
      - RUN_INDEXING_ON_START=1
      - AUTHOR_INDEX_MAP=${AUTHOR_INDEX_MAP:-augustine=/app/indexes/augustine,freud=/app/indexes/freud,plato=/app/indexes/plato}
    command: ["python", "preprocess_and_index.py"]
    profiles: ["index"]
    restart: "no"
    volumes:
      - /root/workspace/AugustineCorpus/texts/augustine_texts:/app/texts/augustine_texts:ro
      - /root/workspace/AugustineCorpus/texts/freud_texts:/app/texts/freud_texts:ro
      - /root/workspace/AugustineCorpus/texts/plato_texts:/app/texts/plato_texts:ro
      - corpus_indexes:/app/indexes
    networks:
      - pericope_net

  pericopeai-api:
    build:
      context: /root/workspace/AugustineService   # backend repo path
      dockerfile: Dockerfile                  # update if named differently
    env_file:
      - /root/workspace/AugustineService/.env      # ensure this exists and is sanitized
    environment:
      - CORPUS_API_URL=${CORPUS_API_URL:-http://augustine-corpus-live:8001}
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_USER=${MYSQL_USER:-augustine}
      - MYSQL_PASS=${MYSQL_PASS:-password}
      - MYSQL_DB=${MYSQL_DB:-augustine_chat}
    ports:
      - "18000:8080"                          # host:container (uvicorn listens on 8080)
    depends_on:
      - mysql
    networks:
      - pericope_net
    restart: unless-stopped

  pericopeai-frontend:
    build:
      context: /root/workspace/AugustineFE        # frontend repo path
      dockerfile: Dockerfile                  # update if named differently
      args:
        REACT_APP_ROOT_URL: https://pericopeai.com
        REACT_APP_ENVIRONMENT: prd
        REACT_APP_AUGUSTINE_API_KEY: ${REACT_APP_AUGUSTINE_API_KEY:-}
        REACT_APP_KEYCLOAK_URL: https://auth.pericopeai.com
        REACT_APP_KEYCLOAK_REALM: pericope
        REACT_APP_KEYCLOAK_CLIENT_ID: pericope-web
    ports:
      - "13080:80"                            # host:container
    networks:
      - pericope_net
    restart: unless-stopped

# Notes:
# - Update the build contexts and dockerfile names to match your cloned repos.
# - Ensure env files exist and contain rotated/safe values.
# - Host ports 18000/13080 are chosen to avoid conflicts; update Nginx upstreams to point there after containers are healthy.
# - Corpus service is expected on the internal network at 8001; provide CORPUS_IMAGE or build/run via AugustineCorpus/docker-compose.corpus.yml.
