graph TD

%% â”€â”€â”€ USER TRAFFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
U["ðŸŒ User Browser (pericopeai.com)"] -->|HTTPS 443| NGINX

%% â”€â”€â”€ NGINX REVERSE PROXY (HOST) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NGINX["ðŸ§­ NGINX Reverse Proxy (Host, Contabo)"]
    N1["Ports 80/443 on 89.117.151.145"]
    N2["/etc/nginx/sites-available/pericopeai.conf â†’ routing"]
    N3["/etc/letsencrypt/ â†’ SSL certificates"]
    N4["location / â†’ proxy_pass http://127.0.0.1:13080 (FE container)"]
    N5["location /api â†’ proxy_pass http://127.0.0.1:18000 (API container)"]
    N6["location /auth â†’ proxy_pass https://auth.pericopeai.com"]
end

%% â”€â”€â”€ FRONTEND (CONTAINER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FRONTEND["ðŸŽ¨ pericopeai-frontend (container)"]
    F1["Build from /root/workspace/AugustineFE"]
    F2["nginx inside container on :80 â†’ host :13080"]
end

NGINX -->|proxies / to FE| F1

%% â”€â”€â”€ FASTAPI BACKEND (CONTAINER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FASTAPI["âš™ï¸ pericopeai-api (container)"]
    B1["/root/workspace/AugustineService â†’ uvicorn on :8080 â†’ host :18000"]
    B2["routes/auth.py â†’ OIDC exchange"]
    B3["routes/chat.py â†’ Chat and RAG endpoints"]
    B4[".env â†’ DB creds (HostGator), OIDC config"]
end

NGINX -->|proxy /api| FASTAPI

%% â”€â”€â”€ DATABASE (REMOTE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€--------
subgraph DB["ðŸ—„ï¸ HostGator MySQL (remote)"]
    D1["DB: cwrihote_chatbook (per .env)"]
end

FASTAPI -->|SQLAlchemy ORM| DB

%% â”€â”€â”€ KEYCLOAK INSTANCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph KC["ðŸ” Keycloak (Two runtimes present)"]
    K1["Host Java â†’ 8080 (active)"]
    K2["Docker container â†’ 8081 (duplicate)"]
    K3["/opt/keycloak/data/realms/pericope.json â†’ Realm config"]
    K4["/opt/keycloak/themes/pericope/ â†’ Custom login theme"]
    K5["/opt/keycloak/conf/keycloak.conf â†’ Server config"]
end

FASTAPI -->|POST /token| KC
U -->|Redirect /auth| KC

%% â”€â”€â”€ NETWORKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NET["ðŸ•¸ï¸ Host networking (Contabo)"]
    NGINX -.->|localhost| FASTAPI
    FASTAPI -.->|localhost| DB
    KC -.->|8080/8081| NGINX
    NGINX -.->|public| U
end

%% â”€â”€â”€ FOLDER SUMMARY NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph SUMMARY["ðŸ“‚ Folder â†’ Function Mapping"]
    S1["/etc/nginx/ â†’ Reverse proxy + SSL configuration"]
    S2["/var/www/pericopeai/ â†’ Frontend build and static assets"]
    S3["/var/www/pericopeai.com/AugustineService/ â†’ FastAPI backend codebase"]
    S4["/var/lib/mysql/ â†’ Persistent database data"]
    S5["/opt/keycloak/ â†’ Identity provider realm + theme"]
end

NGINX --> S1
FRONTEND --> S2
FASTAPI --> S3
DB --> S4
KC --> S5
