graph TD

%% â”€â”€â”€ USER TRAFFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
U["ðŸŒ User Browser (pericopeai.com)"] -->|HTTPS 443| NGINX

%% â”€â”€â”€ NGINX REVERSE PROXY (HOST) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NGINX["ðŸ§­ NGINX Reverse Proxy (Host, Contabo)"]
    N1["Ports 80/443 on 89.117.151.145"]
    N2["/etc/nginx/sites-available/pericopeai.conf â†’ routing"]
    N3["/etc/letsencrypt/ â†’ SSL certificates"]
    N4["location / â†’ proxy_pass http://127.0.0.1:13080 (FE container)"]
    N5["location /api â†’ proxy_pass http://127.0.0.1:18000 (API container)"]
    N6["location /auth â†’ proxy_pass https://auth.pericopeai.com"]
end

%% â”€â”€â”€ FRONTEND (CONTAINER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FRONTEND["ðŸŽ¨ pericopeai-frontend (container)"]
    F1["Build from /root/workspace/AugustineFE"]
    F2["nginx inside container on :80 â†’ host :13080"]
end

NGINX -->|proxies / to FE| F1

%% â”€â”€â”€ FASTAPI BACKEND (CONTAINER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FASTAPI["âš™ï¸ pericopeai-api (container)"]
    B1["/root/workspace/AugustineService â†’ uvicorn on :8080 â†’ host :18000"]
    B2["routes/auth.py â†’ OIDC exchange"]
    B3["routes/chat.py â†’ Chat and RAG endpoints"]
    B4[".env â†’ DB creds (local MySQL), OIDC config"]
    B5["CORPUS_API_URL â†’ http://augustine-corpus-1-0-0:8001"]
end

NGINX -->|proxy /api| FASTAPI

%% â”€â”€â”€ CORPUS SERVICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph CORPUS["ðŸ“š Augustine Corpus (container)"]
    C1["augustine-corpus-1-0-0 â†’ port 8001"]
    C2["Indexes volume: corpus_indexes"]
end

%% â”€â”€â”€ DATABASE (CONTAINER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-----
subgraph DB["ðŸ—„ï¸ MySQL (container)"]
    D1["mysql:8.0 â†’ port 3306 (host-mapped as ${MYSQL_HOST_PORT:-3307})"]
    D2["Volume: mysql_data"]
end

FASTAPI -->|SQLAlchemy ORM| DB
FASTAPI -->|Corpus calls| CORPUS

%% â”€â”€â”€ KEYCLOAK INSTANCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph KC["ðŸ” Keycloak (Two runtimes present)"]
    K1["Host Java â†’ 8080 (active)"]
    K2["Docker container â†’ 8081 (duplicate)"]
    K3["/opt/keycloak/data/realms/pericope.json â†’ Realm config"]
    K4["/opt/keycloak/themes/pericope/ â†’ Custom login theme"]
    K5["/opt/keycloak/conf/keycloak.conf â†’ Server config"]
end

FASTAPI -->|POST /token| KC
U -->|Redirect /auth| KC

%% â”€â”€â”€ NETWORKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NET["ðŸ•¸ï¸ Host networking (Contabo)"]
    NGINX -.->|localhost| FASTAPI
    FASTAPI -.->|localhost| CORPUS
    FASTAPI -.->|pericope_net| DB
    KC -.->|8080/8081| NGINX
    NGINX -.->|public| U
end

%% â”€â”€â”€ FOLDER SUMMARY NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph SUMMARY["ðŸ“‚ Folder â†’ Function Mapping"]
    S1["/etc/nginx/ â†’ Reverse proxy + SSL configuration"]
    S2["/var/www/pericopeai/ â†’ Frontend build and static assets"]
    S3["/var/www/pericopeai.com/AugustineService/ â†’ FastAPI backend codebase"]
    S4["mysql_data â†’ local DB persistence"]
    S5["/opt/keycloak/ â†’ Identity provider realm + theme"]
    S6["Corpus service (AugustineCorpus compose) â†’ port 8001"]
end

NGINX --> S1
FRONTEND --> S2
FASTAPI --> S3
DB --> S4
KC --> S5
CORPUS --> S6
