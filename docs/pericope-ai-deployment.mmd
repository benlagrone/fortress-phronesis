graph TD

%% â”€â”€â”€ USER TRAFFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
U["ðŸŒ User Browser (pericopeai.com)"] -->|HTTPS 443| NGINX

%% â”€â”€â”€ NGINX REVERSE PROXY (HOST) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NGINX["ðŸ§­ NGINX Reverse Proxy (Host, Contabo)"]
    N1["Ports 80/443 on 89.117.151.145"]
    N2["/etc/nginx/sites-available/pericopeai.conf â†’ routing"]
    N3["/etc/letsencrypt/ â†’ SSL certificates"]
    N4["location / â†’ serves React build from /var/www/pericopeai/"]
    N5["location /api â†’ proxy_pass http://127.0.0.1:8000"]
    N6["location /auth â†’ proxy_pass https://auth.pericopeai.com"]
end

%% â”€â”€â”€ FRONTEND STATIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FRONTEND["ðŸŽ¨ React Frontend (Static Files)"]
    F1["/var/www/pericopeai/build/ â†’ React compiled app"]
    F2["/var/www/pericopeai/assets/ â†’ images, fonts, js bundles"]
    F3["/var/www/pericopeai/config.json â†’ Keycloak + API URLs"]
end

NGINX -->|serves static| F1

%% â”€â”€â”€ FASTAPI BACKEND (HOST PROCESS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph FASTAPI["âš™ï¸ FastAPI Backend (Host process)"]
    B1["/var/www/pericopeai.com/AugustineService/main.py â†’ uvicorn"]
    B2["routes/auth.py â†’ Handles OIDC exchange"]
    B3["routes/chat.py â†’ Chat and RAG endpoints"]
    B4["utils/token_handler.py â†’ JWT parsing + refresh"]
    B5["db/models.py â†’ SQLAlchemy models"]
    B6[".env â†’ Secrets, DB creds, Keycloak config"]
    B7["logs/ â†’ Runtime logs"]
end

NGINX -->|proxy /api| FASTAPI
FASTAPI -->|Port 8000| DB

%% â”€â”€â”€ DATABASE (HOST) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph DB["ðŸ—„ï¸ MariaDB (Host)"]
    D1["Port 3306 localhost"]
    D2["/var/lib/mysql/users"]
    D3["/var/lib/mysql/sessions"]
    D4["/var/lib/mysql/messages"]
    D5["/var/lib/mysql/persona_configs"]
end

FASTAPI -->|SQLAlchemy ORM| DB

%% â”€â”€â”€ KEYCLOAK INSTANCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph KC["ðŸ” Keycloak (Two runtimes present)"]
    K1["Host Java â†’ 8080 (active)"]
    K2["Docker container â†’ 8081 (duplicate)"]
    K3["/opt/keycloak/data/realms/pericope.json â†’ Realm config"]
    K4["/opt/keycloak/themes/pericope/ â†’ Custom login theme"]
    K5["/opt/keycloak/conf/keycloak.conf â†’ Server config"]
end

FASTAPI -->|POST /token| KC
U -->|Redirect /auth| KC

%% â”€â”€â”€ NETWORKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph NET["ðŸ•¸ï¸ Host networking (Contabo)"]
    NGINX -.->|localhost| FASTAPI
    FASTAPI -.->|localhost| DB
    KC -.->|8080/8081| NGINX
    NGINX -.->|public| U
end

%% â”€â”€â”€ FOLDER SUMMARY NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subgraph SUMMARY["ðŸ“‚ Folder â†’ Function Mapping"]
    S1["/etc/nginx/ â†’ Reverse proxy + SSL configuration"]
    S2["/var/www/pericopeai/ â†’ Frontend build and static assets"]
    S3["/var/www/pericopeai.com/AugustineService/ â†’ FastAPI backend codebase"]
    S4["/var/lib/mysql/ â†’ Persistent database data"]
    S5["/opt/keycloak/ â†’ Identity provider realm + theme"]
end

NGINX --> S1
FRONTEND --> S2
FASTAPI --> S3
DB --> S4
KC --> S5
